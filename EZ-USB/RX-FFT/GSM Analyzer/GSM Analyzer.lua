

--[[

O2:

   [L1] [ARFCN: 1001] [MCC: 262] [MNC: 7] [LAC: 50834] [CellID: 206]
   [L1] [SDCCH 7] - [T1:  1205 T2: 23 T3: 31 TN: 1 FN:  1598269]
		COUNT: 2468756 Burst #0 (Decrypted) i[]: 100000010001110101010000000010100000000111111101010000001010000100010111010100000000101000010000010101010100000010 (   Key   ) c[]: 010111011011100101000011110100100000000011010000111100101111101001100100111001001010000000001110011110001000101010 (Encrypted) e[]: 110111001010010000010011110110000000000100101101101100100101101101110011101101001010101000011110001011011100101000
		COUNT: 2468789 Burst #1 (Decrypted) i[]: 101010111111111101000000101010101111111111110100000000100010111111111111010101000000001010101011011101010000001000 (   Key   ) c[]: 110000100110000111010100010100101100110010110110101000011110010000000110011001111100001111100111001011011010001000 (Encrypted) e[]: 011010011001111010010100111110000011001101000010101000111100101111111001001100111100000101001100010110001010000000
		COUNT: 2468822 Burst #2 (Decrypted) i[]: 000000011111010101010000100000010001010111010101000010100001010001111101010001000010000000000101110101010100000010 (   Key   ) c[]: 000111010100100110101101010011001000001100100111010100111011010001111000001000000001001001110101111011000000111011 (Encrypted) e[]: 000111001011110011111101110011011001011011110010010110011010000000000101011001000011001001110000001110010100111001
		COUNT: 2468855 Burst #3 (Decrypted) i[]: 000100001010101010111101110101010000000010101110111111010100010000001010101011011101010001000010001011101111010101 (   Key   ) c[]: 010101010001100011100000100011111111101000000100011011010101100000110000010001011011101111111101010100101000010111 (Encrypted) e[]: 010001011011001001011101010110101111101010101010100100000001110000111010111010000110111110111111011111000111000010
   [L2] SAPI: 0  C/R: 1  EA: 1  M: 0  EL: 1  L: 0  U Format, U=0 UI
		======= encrypted =======
		Raw Data
			 03 03 01 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B

   [L1] [ARFCN: 1001] [MCC: 262] [MNC: 7] [LAC: 51802] [CellID: 206]
   [L1] [SDCCH 6] - [T1:   978 T2: 10 T3: 27 TN: 1 FN:  1297722]
		======= Found encryption key: D9AEE14845BB05DD =======
		COUNT: 2003719 Burst #0 (Decrypted) i[]: 100000000101110101010100000000100001000101011101000000100010000000011111110100010000001000010100011111010100010010 (   Key   ) c[]: 010111111010100011010010011101011001110010000100111000100111001010110110001001101001110011000001000100000111101111 (Encrypted) e[]: 110111111111010110000110011101111000110111011001111000000101001010101001111101111001111011010101011011010011111101
		COUNT: 2003752 Burst #1 (Decrypted) i[]: 101011101101011101010000100010101010110101110101000010001010111011110111010000000010101010101111011101010001000010 (   Key   ) c[]: 010010000111110011111111100101011011111010101000010110011110000011101001001111011111101001100110110001011000101000 (Encrypted) e[]: 111001101010101110101111000111110001001111011101010100010100111000011110011111011101000011001001101100001001101010
		COUNT: 2003785 Burst #2 (Decrypted) i[]: 000100010101010101010000101000000101010101010100000010000000000001010101000001000000000101000101010101000100000010 (   Key   ) c[]: 100110111101001110110001011101110111011011111101111000111001111111101101000110000010111100100011111100101100001101 (Encrypted) e[]: 100010101000011011100001110101110010001110101001111010111001111110111000000111000010111001100110101001101000001111
		COUNT: 2003818 Burst #3 (Decrypted) i[]: 010100001000101111110101010101010000001010101010111101010001010000101011101111010101010001000010001010101111010101 (   Key   ) c[]: 101111110100010111111101100011011111110100100000000100001100111001110011001010010101100111111101110011111111101010 (Encrypted) e[]: 111011111100111000001000110110001111111110001010111001011101101001011000100101000000110110111111111001010000111111
   [L2] SAPI: 0  C/R: 0  EA: 1  M: 0  EL: 1  L: 0  S Format, N(R)=2 S=0 RR
		======= encrypted =======
		Raw Data
			 01 41 01 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B AA


  [L1] [ARFCN: 1001] [Burst: 7317130] [MCC: 262] [MNC: 7] [LAC: 50834] [CellID: 206] 
  [L1] [SDCCH 3] - [T1:   994 T2: 14 T3: 15 TN: 1 FN:  1318110]
       Raw L1 data
        i[]: 100000010001010101010100000010100001000101011101000100101000000100011101110101010000001000000000011111010101000010 k[]: 100000011100101011011111100011011001100111000110001111101111101101111000010101111000011111010001000010101101000100 e[]: 000000001101111110001011100001111000100010011011001011000111101001100101100000101000010111010001011101111000000110
        i[]: 101011101101111101010000100010101011110101010100000010101010101111110111010001000010001010111011011101010101000010 k[]: 110100001101010010101110101011111011000101101011010011000000010111110100110100100111101000101001000011111000000101 e[]: 011111100000101111111110001001010000110000111111010001101010111000000011100101100101100010010010011110101101000111
        i[]: 000101011111010101000000001000010101010111010101000010000000000001011101000101000000000101000101110101000100001010 k[]: 100001111100100011101000100000011011101111010110010010001010111110001110101110010010110001101101111110011111010111 e[]: 100100100011110110101000101000001110111000000011010000001010111111010011101011010010110100101000001011011011011101
        i[]: 010100000000101011110111110101000000001010111010111111010001010000101011111011011101010001001010001010111101110101 k[]: 111100101011110001100110101001000101011011111101101001010100100101110011100101000111010110101001010010111100000110 e[]: 101000101011011010010001011100000101010001000111010110000101110101011000011110011010000111100011011000000001110011
  [L2] ======= encrypted =======
       SAPI: 3  C/R: 0  EA: 1  M: 0  EL: 1  L: 0  S Format, N(R)=1 S=0 RR
       Raw L2 data
           0D 21 01 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B AA 
			 
			 
  [L1] [ARFCN: 1001] [Burst: 7393038] [MCC: 262] [MNC: 7] [LAC: 50834] [CellID: 206] 
  [L1] [SDCCH 6] - [T1:  1008 T2: 18 T3: 27 TN: 1 FN:  1337094]
       Raw L1 data
        i[]: 100000010101110101010100000000100001000101011101010000101000000001011111110101010000001000010000010111010101010000 k[]: 001001000100000011110000000010000010111010101110010001110111110001000010110010100010000000000000001000000110001011 e[]: 101001010001110110100100000010100011111111110011000001011111110000011101000111110010001000010000011111010011011011
        i[]: 101011101111111101010000101010101110110111010100010010001010111111110111010001000010101010111111111101010100000010 k[]: 110111101100110001111100000001011010101011111100001101011110001111001101011000001100101111001010010001010010100011 e[]: 011100000011001100101100101011110100011100101000011111010100110000111010001001001110000101110101101100000110100001
        i[]: 000000010101010101010000000000010101010111010000000010000001010001110101000001001000000101000101010101000100101010 k[]: 000011111011100001101101111000111000001010001011101000000011110111101010010111010011011111111100110011110010111000 e[]: 000011101110110100111101111000101101011101011011101010000010100110011111010110011011011010111001100110110110010010
        i[]: 000100001010101011110101110100000000001010111110110101010001010000101011111111110101010001001010001011101111110101 k[]: 110011001101111100101111111000111010110110001000000101101101001100101010011011100011001101010100001100011011110101 e[]: 110111000111010111011010001100111010111100110110110000111100011100000001100100010110011100011110000111110100000000
  [L2] ======= encrypted =======
       SAPI: 0  C/R: 0  EA: 1  M: 0  EL: 1  L: 0  S Format, N(R)=3 S=0 RR
       Raw L2 data
           01 61 01 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B AA 


eplus:

  [L1] [ARFCN: 995] [MCC: 262] [MNC: 3] [LAC: 9417] [CellID: 58057]
  [L1] [SDCCH 0] - [T1:   288 T2: 21 T3: 25 TN: 0 FN:   382117]
		COUNT: 590546 Burst #0 (Decrypted) i[]: 100000000001111101010000000000100001000111111101010000001010000101010111110100000000101000000100010111010100010010 (   Key   ) c[]: 101101000001110010110000011001001110010101001101100011000101011011010110000100010010010100011100110111100100111000 (Encrypted) e[]: 001101000000001111100000011001101111010010110000110011001111011110000001110000010010111100011000100000110000101010
		COUNT: 590579 Burst #1 (Decrypted) i[]: 101010101101011101010000101010101110111101010100010000101010101011111111010100000000101010101111111101010000001010 (   Key   ) c[]: 111011010100001110101111011110111100010000001000110101100010111100101011110111110101011001101100001101001001000110 (Encrypted) e[]: 010001111001010011111111110100010010101101011100100101001000010111010100100011110101110011000011110000011001001100
		COUNT: 590612 Burst #2 (Decrypted) i[]: 000000010111010100010000100000000001011101010101000010000000000001010101010000000000000001010111110101010100100010 (   Key   ) c[]: 011010111110000011000100110101111000111100011111100100000110001101110110100111111001100000100110111010100110100000 (Encrypted) e[]: 011010101001010111010100010101111001100001001010100110000110001100100011110111111001100001110001001111110010000010
		COUNT: 590645 Burst #3 (Decrypted) i[]: 000100000010101110111111010101000000001010101110110101010100000000101010101111111101010001000010001011101101110101 (   Key   ) c[]: 001011010000011101000011010100111011010111011101111101111010100100110111000100100011000010010000000100100101101010 (Encrypted) e[]: 001111010010110011111100000001111011011101110011001000101110100100011101101011011110010011010010001111001000011111

  [L2] SAPI: 0  C/R: 0  EA: 1  M: 0  EL: 1  L: 0  S Format, N(R)=4 S=0 RR
       ======= encrypted =======
       Raw L2 Data
           01 81 01 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B


  [L1] [ARFCN: 995] [MCC: 262] [MNC: 3] [LAC: 9417] [CellID: 58057]
  [L1] [SDCCH 0] - [T1:   288 T2: 18 T3: 25 TN: 0 FN:   382270]
		COUNT: 590543 Burst #0 (Decrypted) i[]: 100000000101010101010000001000100001000101011101010000000010000101010101110101000000001000010100011111010100010010 (   Key   ) c[]: 011110011110100011001011000001100111111000000101111101010001000001101011011010110111100010000011001001100011101101 (Encrypted) e[]: 111110011011110110011011001001000110111101011000101101010011000100111110101111110111101010010111010110110111111111
		COUNT: 590576 Burst #1 (Decrypted) i[]: 101010111101011101010000001010101010111101110100010000101010101111110111010101000010101010111111011101010100000010 (   Key   ) c[]: 101110101111001001010010000110011001110110110110100111111011001001010100100101001011010100001010111001011011101011 (Encrypted) e[]: 000100010010010100000010001100110011001011000010110111010001100110100011110000001001111110110101100100001111101001
		COUNT: 590609 Burst #2 (Decrypted) i[]: 000100011111010100010000000000000101010101010100000010100000000001110101010101000000000000010111110101000100001010 (   Key   ) c[]: 000010111001000101101010000110011001011101011101011000010111111110101101010111001000010010111001000111111011010001 (Encrypted) e[]: 000110100110010001111010000110011100001000001001011010110111111111011000000010001000010010101110110010111111011011
		COUNT: 590642 Burst #3 (Decrypted) i[]: 000100000010101011111111110100000000000010111010110101010101010010101010101011011101010101000000001010101101010101 (   Key   ) c[]: 111110100001011110110011011000111010000101100011100001100001100110001011001001101111101010110011010011000110000110 (Encrypted) e[]: 111010100011110101001100101100111010000111011001010100110100110100100001100010110010111111110011011001101011010011
  [L2] SAPI: 0  C/R: 0  EA: 1  M: 0  EL: 1  L: 0  U Format, U=12 UA
       ======= encrypted =======
       Raw L2 Data
           01 73 01 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B


  [L1] [ARFCN: 995] [MCC: 262] [MNC: 3] [LAC: 9417] [CellID: 58057]
  [L1] [SDCCH 0] - [T1:   288 T2: 17 T3: 25 TN: 0 FN:   382321]
		COUNT: 590542 Burst #0 (Decrypted) i[]: 100000010001110101010000000010100000000111111101010000001010000100010111010100000000101000010000010101010100000010 (   Key   ) c[]: 011111011010110101001000001010010100110010101000100101000010011000000101111110010010011010001010111011010000111111 (Encrypted) e[]: 111111001011000000011000001000110100110101010101110101001000011100010010101010010010110010011010101110000100111101
		COUNT: 590575 Burst #1 (Decrypted) i[]: 101010111111111101000000101010101111111111110100000000100010111111111111010101000000001010101011011101010000001000 (   Key   ) c[]: 000000000100111111111011000001001100000010010001011111111001010001011101010111100111011010101111000010101011101110 (Encrypted) e[]: 101010111011000010111011101011100011111101100101011111011011101110100010000010100111010000000100011111111011100110
		COUNT: 590608 Burst #2 (Decrypted) i[]: 000000011111010101010000100000010001010111010101000010100001010001111101010001000010000000000101110101010100000010 (   Key   ) c[]: 011101110010110101011110110111110010101011000000110000111111110100100110100001111111111001000101000100011001011010 (Encrypted) e[]: 011101101101100000001110010111100011111100010101110010011110100101011011110000111101111001000000110001001101011000
		COUNT: 590641 Burst #3 (Decrypted) i[]: 000100001010101010111101110101010000000010101110111111010100010000001010101011011101010001000010001011101111010101 (   Key   ) c[]: 010010000101000100110110111100110110000010010011110100000101001001101011110000010011010010011010100111111001101001 (Encrypted) e[]: 010110001111101110001011001001100110000000111101001011010001011001100001011011001110000011011000101100010110111100
  [L2] SAPI: 0  C/R: 1  EA: 1  M: 0  EL: 1  L: 0  U Format, U=0 UI
       ======= encrypted =======
       Raw L2 Data
           03 03 01 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B 2B


		
]]--


FrameUI   = "100000010001110101010000000010100000000111111101010000001010000100010111010100000000101000010000010101010100000010 101010111111111101000000101010101111111111110100000000100010111111111111010101000000001010101011011101010000001000 000000011111010101010000100000010001010111010101000010100001010001111101010001000010000000000101110101010100000010 000100001010101010111101110101010000000010101110111111010100010000001010101011011101010001000010001011101111010101"
FrameUA12 = "100000000101010101010000001000100001000101011101010000000010000101010101110101000000001000010100011111010100010010 101010111101011101010000001010101010111101110100010000101010101111110111010101000010101010111111011101010100000010 000100011111010100010000000000000101010101010100000010100000000001110101010101000000000000010111110101000100001010 000100000010101011111111110100000000000010111010110101010101010010101010101011011101010101000000001010101101010101"
FrameRR1  = "100000010001010101010100000010100001000101011101000100101000000100011101110101010000001000000000011111010101000010 101011101101111101010000100010101011110101010100000010101010101111110111010001000010001010111011011101010101000010 000101011111010101000000001000010101010111010101000010000000000001011101000101000000000101000101110101000100001010 010100000000101011110111110101000000001010111010111111010001010000101011111011011101010001001010001010111101110101"
FrameRR2  = "100000000101110101010100000000100001000101011101000000100010000000011111110100010000001000010100011111010100010010 101011101101011101010000100010101010110101110101000010001010111011110111010000000010101010101111011101010001000010 000100010101010101010000101000000101010101010100000010000000000001010101000001000000000101000101010101000100000010 010100001000101111110101010101010000001010101010111101010001010000101011101111010101010001000010001010101111010101"
FrameRR3  = "100000010101110101010100000000100001000101011101010000101000000001011111110101010000001000010000010111010101010000 101011101111111101010000101010101110110111010100010010001010111111110111010001000010101010111111111101010100000010 000000010101010101010000000000010101010111010000000010000001010001110101000001001000000101000101010101000100101010 000100001010101011110101110100000000001010111110110101010001010000101011111111110101010001001010001011101111110101"
FrameRR4  = "100000000001111101010000000000100001000111111101010000001010000101010111110100000000101000000100010111010100010010 101010101101011101010000101010101110111101010100010000101010101011111111010100000000101010101111111101010000001010 000000010111010100010000100000000001011101010101000010000000000001010101010000000000000001010111110101010100100010 000100000010101110111111010101000000001010101110110101010100000000101010101111111101010001000010001011101101110101"

BruteForceAllConnections = false;
Provider = "?"
GSMAnalyzer = nil;



function Init(instance)
    GSMAnalyzer = instance;
	print("GSM Analyzer LUA scripts loaded");
    
    instance.KrakenHostAddress = "localhost"
    
    -- try to connect and print status
	if(instance.Parameters.CipherCracker.Available) then
        print("Kraken Connected");
    end
    
end

function ShouldCrack(burst, param)
	local crack, reason = ShouldCrackInternal(burst, param);
	
	reason = reason.." (Cause: '"..burst.EstablishmentCause.."', Service: '"..burst.ServiceType.."', "..burst.CryptedFrames.." frames)";
	
	if(crack) then
		print("Cracking due to "..reason);
		
		if(burst.CryptedFrames > 30) then
			crack = false;
			reason = reason.." but skipping - far too many frames ";
		end
	end
	
	return crack, reason;
end

function GetCrackBits(frame, frames, burst, param)
	print("Providing crack bits for frame "..frame.."/"..frames);
    
    if(GSMAnalyzer.Parameters.MNC == 2) then
        print("Detected D2 Vodafone");
        Provider = "d2";
    elseif(GSMAnalyzer.Parameters.MNC == 7) then
        print("Detected O2");
        Provider = "o2";
    end
    
	if(Provider == "?") then
        print("D D2 Vodafone");
        Provider = "d2";
    end
	
	if(Provider == "d2") then
	
		-- D2: (ARFCN 12)
		--   location update:
		--   first encrypted always an I/UI frame
		--   last 2-3 encryped are always UA or UI
		if(frame == 1) then
			print("    D2: Assuming UI or RR2");
			return FrameUI, FrameRR2;
		elseif(frame > frames-3) then
			print("    D2: Assuming last 3 UI/UA");
			return FrameUI, FrameUA12;
		end
	
	elseif(Provider == "o2") then
	
		-- O²: (ARFCN 1001)
		--    the last 7 frames always UI
		--    the first frame always RR, mostly with N(R)=2
		--
		if(frames > 12) then
			if(frame > frames-7) then
				print("    O²: Assuming last 7 UI");
				return FrameUI;
			elseif(frame == 1) then
				print("    O²: Assuming first RR2");
				return FrameRR2;
			end
		else
			if(frame > frames-1) then
				print("    O²: Assuming last frame UI");
				return FrameUI;
			elseif(frame == 1) then
				print("    O²: Assuming first RR2");
				return FrameRR2;
				
			-- these are in short SDCCH comms like channel assignment for TCH calls
			elseif(frame == 2) then
				print("    O²: Assuming second UI");
				return FrameRR2;
			elseif(frame == 3) then
				print("    O²: Assuming third RR3");
				return FrameRR2;
			end
		end
	end
	
	print("    skipping");
	return nil
end

function ShouldCrackInternal(burst, param)

	if(BruteForceAllConnections) then
			return true, "brute force: "..burst.EstablishmentCause.." "..burst.ServiceType.." ";
	end
	
	if(string.find(burst.EstablishmentCause, "Answer to paging")) then
		if(burst.CryptedFrames > 10) then
			return true, "'Answer to paging', maybe some SMS"
		end
		return false, "'Answer to paging', <= 10 frames. maybe some phone call setup."
	end
	
	if(string.find(burst.EstablishmentCause, "Other procedures")) then
		if(string.find(burst.ServiceType, "Short message service")) then
			return false, "'SMS request', no need for sent SMS."
		end
		if(string.find(burst.ServiceType, "updating")) then
			return false, "'Location updating', not interesting."
		end
		if(string.find(burst.ServiceType, "Supplementary")) then
			return false, "'Supplementary', no idea, always empty."
		end
		
		return false, "'Other procedures', maybe some other SMS stuff?"
	end
	
	if(string.find(burst.EstablishmentCause, "Location updating")) then
		return false, "'Location updating', not interesting."
	end
	
	
	
	if(string.find(burst.ServiceType, "updating")) then
		return false, "'Location updating', not interesting."
	end
	
	if(string.find(burst.ServiceType, "Short message service")) then
		return false, "'SMS request', no need for sent SMS."
	end
	
	if(string.find(burst.ServiceType, "Mobile originating call")) then
		return false, "'Call/Data', due to hopping useless, but try. Maybe thats some non-hopping call."
	end
	
	if(string.find(burst.ServiceType, "Supplementary")) then
		return false, "'Supplementary', no idea, always empty."
	end
	
	return false, ""
end
